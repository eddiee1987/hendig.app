(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[111],{2099:(e,t,r)=>{"use strict";r.d(t,{HK:()=>c,LY:()=>d,ND:()=>n,qi:()=>o,y9:()=>i});var a=r(851);let l="https://jntsodzdafscwksizfov.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpudHNvZHpkYWZzY3drc2l6Zm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM1NTU1NDAsImV4cCI6MjA1OTEzMTU0MH0.bHJS17KYKP4n2Abs0rp2oO0pFBGW3GorNhsJFyDljR8";console.log("Supabase URL:",l),console.log("Supabase Anon Key:",s?"Set":"Not set"),l&&s||console.error("Supabase credentials are not set correctly in environment variables");let n=(0,a.UU)(l,s);async function i(){try{let{data:e,error:t}=await n.from("lager").select("navn, antall");if(t)return console.error("Error fetching lager:",t),{};let r={};return null==e||e.forEach(e=>{r[e.navn.toLowerCase().replaceAll(" ","_").replaceAll("\xe5","a").replaceAll("\xe6","ae").replaceAll("\xf8","o")]=e.antall}),r}catch(e){return console.error("Unexpected error fetching lager:",e),{}}}async function c(e){try{let{data:t,error:r}=await n.from("lager").select("id, navn");if(r)return void console.error("Error fetching lager for update:",r);for(let[r,a]of Object.entries(e)){let e=r.replaceAll("_"," ").replaceAll("ae","\xe6").replaceAll("o","\xf8").replaceAll("a","\xe5"),l=null==t?void 0:t.find(e=>e.navn.toLowerCase().replaceAll(" ","_")===r);l?await n.from("lager").update({antall:Number(a)}).eq("id",l.id):await n.from("lager").insert([{navn:e,antall:Number(a)}])}}catch(e){console.error("Unexpected error updating lager:",e)}}async function o(){try{let{data:e,error:t}=await n.from("lager_transactions").select("created_at, type, antall, kommentar, lager_id, lager:lager_id(navn)").order("created_at",{ascending:!1}).limit(100);if(t)return console.error("Error fetching lager historikk:",t),window.__supabaseLagerHistorikkError=t,[];return(e||[]).map(e=>{var t,r;return{created_at:e.created_at,navn:(null==(r=e.lager)||null==(t=r[0])?void 0:t.navn)||"",type:e.type,antall:e.antall,kommentar:e.kommentar||""}})}catch(e){return console.error("Unexpected error fetching lager historikk:",e),[]}}async function d(e){let{key:t,type:r,antall:a,kommentar:l}=e;try{let e=t.replaceAll("_"," ").replaceAll("ae","\xe6").replaceAll("o","\xf8").replaceAll("a","\xe5"),s=null,i=0,{data:c}=await n.from("lager").select("id, antall").eq("navn",e).limit(1);if(c&&0!==c.length){if(s=c[0].id,i=c[0].antall,"inntak"===r)i+=a;else if("uttak"===r){if(c[0].antall<a)return{error:"Ikke nok p\xe5 lager for uttak"};i-=a}else"manuell"===r&&(i=a);let{error:e}=await n.from("lager").update({antall:i}).eq("id",s);if(e)return{error:"Kunne ikke oppdatere lagerbeholdning"}}else{if("manuell"!==r)return{error:"Fant ikke varen i lageret"};let{data:t,error:l}=await n.from("lager").insert([{navn:e,antall:Number(a)}]).select("id").single();if(l||!t)return{error:"Kunne ikke opprette ny vare"};s=t.id,i=Number(a)}let{error:o}=await n.from("lager_transactions").insert({lager_id:s,type:r,antall:a,kommentar:l});if(o)return{error:"Kunne ikke registrere transaksjon"};return{success:!0}}catch(e){return{error:"Uventet feil ved registrering"}}}},3136:(e,t,r)=>{Promise.resolve().then(r.bind(r,3605))},3605:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>m});var a=r(5155),l=r(2115),s=r(5695),n=r(6874),i=r.n(n),c=r(6689),o=r(2099);function d(){let e=(0,s.useParams)(),t=(0,s.useRouter)(),r=e.id,[n,d]=(0,l.useState)(null),[m,u]=(0,l.useState)(!0),[h,p]=(0,l.useState)(null),[_,k]=(0,l.useState)(null);return((0,l.useEffect)(()=>{if((async()=>{let{data:{user:e}}=await o.ND.auth.getUser();e?k(e.id):(p("Bruker ikke logget inn."),u(!1))})(),!r){p("Ingen sjekkliste ID funnet i URL."),u(!1);return}(async()=>{u(!0),p(null);try{let e=await (0,c.$E)(r);e?d(e):p("Kunne ikke finne sjekkliste med ID: ".concat(r,"."))}catch(e){console.error("Error fetching checklist:",e),p("Feil ved lasting av sjekkliste.")}finally{u(!1)}})()},[r,t]),m||null===_)?(0,a.jsx)("div",{className:"container mx-auto p-4",children:"Laster sjekkliste..."}):h&&(!n||void 0===_)?(0,a.jsx)("div",{className:"container mx-auto p-4 text-red-600",children:h}):n?(0,a.jsxs)("div",{className:"container mx-auto p-4",children:[(0,a.jsxs)("nav",{className:"text-sm text-gray-500 mb-4",children:[(0,a.jsx)(i(),{href:"/hms",className:"hover:underline",children:"Hjem"})," /",(0,a.jsx)(i(),{href:"/hms/sjekklister",className:"hover:underline",children:" Sjekklister"})," /",(0,a.jsxs)("span",{className:"text-gray-700",children:[" ",n.template_name||"Sjekkliste"]})]}),(0,a.jsx)("div",{className:"flex justify-between items-center mb-4",children:(0,a.jsx)("h1",{className:"text-2xl font-semibold",children:n.template_name||"Sjekkliste Detaljer"})}),(0,a.jsxs)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden border border-gray-200 p-4 mb-6",children:[(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Status:"})," ",n.status]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Opprettet:"})," ",new Date(n.created_at).toLocaleDateString("nb-NO")," ",new Date(n.created_at).toLocaleTimeString("nb-NO")]}),n.completed_at&&(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Fullf\xf8rt:"})," ",new Date(n.completed_at).toLocaleDateString("nb-NO")," ",new Date(n.completed_at).toLocaleTimeString("nb-NO")]}),(0,a.jsxs)("p",{children:[(0,a.jsx)("strong",{children:"Opprettet av:"})," ",n.created_by_name||"Ukjent Bruker"]}),n.template_description&&(0,a.jsxs)("p",{className:"text-gray-600 text-sm mt-3 bg-gray-50 p-3 rounded border border-gray-200",children:[(0,a.jsx)("strong",{children:"Beskrivelse:"})," ",n.template_description]})]}),(0,a.jsxs)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden border border-gray-200",children:[(0,a.jsx)("div",{className:"bg-teal-600 text-white p-4",children:(0,a.jsx)("h2",{className:"text-xl font-semibold",children:"Elementer"})}),(0,a.jsx)("ul",{className:"divide-y divide-gray-200",children:n.checklist_items.sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()).map((e,t)=>(0,a.jsxs)("li",{className:"p-4 flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center flex-grow mr-4",children:[(0,a.jsx)("span",{className:"text-gray-500 w-8 text-right mr-4 flex-shrink-0",children:t+1}),(0,a.jsx)("span",{className:"text-gray-800",children:e.item_text||e.template_item_id})]}),(0,a.jsx)("input",{type:"checkbox",checked:e.is_checked,disabled:!0,className:"form-checkbox h-5 w-5 text-teal-600 rounded border-gray-300 focus:ring-teal-500 focus:ring-offset-0 focus:ring-2 flex-shrink-0"})]},e.id))})]})]}):(0,a.jsx)("div",{className:"container mx-auto p-4",children:"Fant ikke sjekklisten. Sjekk om IDen i URLen er korrekt."})}let m=()=>(0,a.jsx)(l.Suspense,{fallback:(0,a.jsx)("div",{className:"container mx-auto p-4",children:"Laster..."}),children:(0,a.jsx)(d,{})})},5695:(e,t,r)=>{"use strict";var a=r(8999);r.o(a,"useParams")&&r.d(t,{useParams:function(){return a.useParams}}),r.o(a,"usePathname")&&r.d(t,{usePathname:function(){return a.usePathname}}),r.o(a,"useRouter")&&r.d(t,{useRouter:function(){return a.useRouter}}),r.o(a,"useSearchParams")&&r.d(t,{useSearchParams:function(){return a.useSearchParams}})},6689:(e,t,r)=>{"use strict";r.d(t,{$E:()=>c,Py:()=>s,Y$:()=>i,Yq:()=>o,ix:()=>l,mp:()=>n});var a=r(2099);let l=async()=>{console.log("hmsService: Fetching active checklist templates...");let{data:e,error:t}=await a.ND.from("checklist_templates").select("id, created_at, name, description").eq("is_active",!0).order("name");if(t)throw console.error("Error fetching checklist templates:",t),Error("Could not fetch checklist templates.");return e||[]},s=async e=>{console.log("hmsService: Fetching template with items for ID: ".concat(e));let{data:t,error:r}=await a.ND.from("checklist_templates").select("\n      id,\n      created_at, // Select created_at\n      name,\n      description,\n      checklist_template_items ( id, item_text, item_order )\n    ").eq("id",e).eq("is_active",!0).order("item_order",{referencedTable:"checklist_template_items",ascending:!0}).maybeSingle();if(r)throw console.error("Error fetching template with items:",r),Error("Could not fetch template details.");return t},n=async()=>{console.log("hmsService: Fetching checklists...");let{data:e,error:t}=await a.ND.from("checklists").select("\n      id,\n      created_at,\n      completed_at,\n      status,\n      template_id, // Include template_id\n      user_id, // Include user_id\n      template:checklist_templates ( name, description ),\n      user:profiles ( full_name ) -- Assuming a 'profiles' table linked to auth.users\n      -- department:departments ( name ) -- Optional join if department is linked to checklist or user\n    ").order("created_at",{ascending:!1});if(t)throw console.error("Error fetching checklists:",t),Error("Could not fetch checklists.");return(null==e?void 0:e.map(e=>{var t,r,a;return{id:e.id,template_id:e.template_id,user_id:e.user_id,template_name:(null==(t=e.template)?void 0:t.name)||"Ukjent Mal",template_description:(null==(r=e.template)?void 0:r.description)||null,created_by_name:(null==(a=e.user)?void 0:a.full_name)||"Ukjent Bruker",created_at:e.created_at,completed_at:e.completed_at,status:e.status}}))||[]},i=async(e,t,r)=>{console.log("hmsService: Creating checklist instance for template ".concat(e," by user ").concat(t));let l=Object.entries(r).map(e=>{let[t,r]=e;return{template_item_id:t,is_checked:r}}),{data:s,error:n}=await a.ND.rpc("create_new_checklist",{p_template_id:e,p_user_id:t,p_items:l});return n?(console.error("Error calling create_new_checklist RPC:",n),{success:!1,checklistId:null,error:"Database error during checklist creation."}):s&&"object"==typeof s&&"checklist_id"in s&&s.checklist_id?(console.log("Successfully created checklist with ID:",s.checklist_id),{success:!0,checklistId:s.checklist_id,error:null}):(console.error("RPC create_new_checklist did not return expected checklist_id",s),{success:!1,checklistId:null,error:"Failed to retrieve new checklist ID after creation."})},c=async e=>{var t,r,l;console.log("hmsService: Fetching checklist with items for ID: ".concat(e));let{data:s,error:n}=await a.ND.from("checklists").select("\n      id,\n      created_at,\n      completed_at,\n      status,\n      template_id,\n      user_id,\n      template:checklist_templates ( name, description ),\n      user:profiles ( full_name ),\n      checklist_items (\n        id,\n        template_item_id,\n        is_checked,\n        comment,\n        created_at,\n        template_item:checklist_template_items ( item_text )\n      )\n    ").eq("id",e).maybeSingle();if(n)throw console.error("Error fetching checklist with items:",n),Error("Could not fetch checklist details.");return s?{id:s.id,template_id:s.template_id,user_id:s.user_id,template_name:(null==(t=s.template)?void 0:t.name)||"Ukjent Mal",template_description:(null==(r=s.template)?void 0:r.description)||null,created_by_name:(null==(l=s.user)?void 0:l.full_name)||"Ukjent Bruker",created_at:s.created_at,completed_at:s.completed_at,status:s.status,checklist_items:(s.checklist_items||[]).map(e=>{var t;return{id:e.id,checklist_id:s.id,template_item_id:e.template_item_id,is_checked:e.is_checked,comment:e.comment,created_at:e.created_at,item_text:(null==(t=e.template_item)?void 0:t.item_text)||void 0}})}:null},o=async e=>{console.log("hmsService: Deleting checklist with ID: ".concat(e));let{error:t}=await a.ND.from("checklist_items").delete().eq("checklist_id",e);if(t)return console.error("Error deleting checklist items:",t),{success:!1,error:"Could not delete associated checklist items."};let{error:r}=await a.ND.from("checklists").delete().eq("id",e);return r?(console.error("Error deleting checklist:",r),{success:!1,error:"Could not delete the checklist."}):(console.log("Successfully deleted checklist with ID: ".concat(e)),{success:!0})}}},e=>{var t=t=>e(e.s=t);e.O(0,[851,874,441,684,358],()=>t(3136)),_N_E=e.O()}]);