(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[149],{2099:(e,t,r)=>{"use strict";r.d(t,{HK:()=>c,LY:()=>d,ND:()=>i,qi:()=>o,y9:()=>n});var l=r(851);let a="https://jntsodzdafscwksizfov.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpudHNvZHpkYWZzY3drc2l6Zm92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM1NTU1NDAsImV4cCI6MjA1OTEzMTU0MH0.bHJS17KYKP4n2Abs0rp2oO0pFBGW3GorNhsJFyDljR8";console.log("Supabase URL:",a),console.log("Supabase Anon Key:",s?"Set":"Not set"),a&&s||console.error("Supabase credentials are not set correctly in environment variables");let i=(0,l.UU)(a,s);async function n(){try{let{data:e,error:t}=await i.from("lager").select("navn, antall");if(t)return console.error("Error fetching lager:",t),{};let r={};return null==e||e.forEach(e=>{r[e.navn.toLowerCase().replaceAll(" ","_").replaceAll("\xe5","a").replaceAll("\xe6","ae").replaceAll("\xf8","o")]=e.antall}),r}catch(e){return console.error("Unexpected error fetching lager:",e),{}}}async function c(e){try{let{data:t,error:r}=await i.from("lager").select("id, navn");if(r)return void console.error("Error fetching lager for update:",r);for(let[r,l]of Object.entries(e)){let e=r.replaceAll("_"," ").replaceAll("ae","\xe6").replaceAll("o","\xf8").replaceAll("a","\xe5"),a=null==t?void 0:t.find(e=>e.navn.toLowerCase().replaceAll(" ","_")===r);a?await i.from("lager").update({antall:Number(l)}).eq("id",a.id):await i.from("lager").insert([{navn:e,antall:Number(l)}])}}catch(e){console.error("Unexpected error updating lager:",e)}}async function o(){try{let{data:e,error:t}=await i.from("lager_transactions").select("created_at, type, antall, kommentar, lager_id, lager:lager_id(navn)").order("created_at",{ascending:!1}).limit(100);if(t)return console.error("Error fetching lager historikk:",t),window.__supabaseLagerHistorikkError=t,[];return(e||[]).map(e=>{var t,r;return{created_at:e.created_at,navn:(null==(r=e.lager)||null==(t=r[0])?void 0:t.navn)||"",type:e.type,antall:e.antall,kommentar:e.kommentar||""}})}catch(e){return console.error("Unexpected error fetching lager historikk:",e),[]}}async function d(e){let{key:t,type:r,antall:l,kommentar:a}=e;try{let e=t.replaceAll("_"," ").replaceAll("ae","\xe6").replaceAll("o","\xf8").replaceAll("a","\xe5"),s=null,n=0,{data:c}=await i.from("lager").select("id, antall").eq("navn",e).limit(1);if(c&&0!==c.length){if(s=c[0].id,n=c[0].antall,"inntak"===r)n+=l;else if("uttak"===r){if(c[0].antall<l)return{error:"Ikke nok p\xe5 lager for uttak"};n-=l}else"manuell"===r&&(n=l);let{error:e}=await i.from("lager").update({antall:n}).eq("id",s);if(e)return{error:"Kunne ikke oppdatere lagerbeholdning"}}else{if("manuell"!==r)return{error:"Fant ikke varen i lageret"};let{data:t,error:a}=await i.from("lager").insert([{navn:e,antall:Number(l)}]).select("id").single();if(a||!t)return{error:"Kunne ikke opprette ny vare"};s=t.id,n=Number(l)}let{error:o}=await i.from("lager_transactions").insert({lager_id:s,type:r,antall:l,kommentar:a});if(o)return{error:"Kunne ikke registrere transaksjon"};return{success:!0}}catch(e){return{error:"Uventet feil ved registrering"}}}},5372:(e,t,r)=>{Promise.resolve().then(r.bind(r,7995))},5695:(e,t,r)=>{"use strict";var l=r(8999);r.o(l,"useParams")&&r.d(t,{useParams:function(){return l.useParams}}),r.o(l,"usePathname")&&r.d(t,{usePathname:function(){return l.usePathname}}),r.o(l,"useRouter")&&r.d(t,{useRouter:function(){return l.useRouter}}),r.o(l,"useSearchParams")&&r.d(t,{useSearchParams:function(){return l.useSearchParams}})},6689:(e,t,r)=>{"use strict";r.d(t,{$E:()=>c,Py:()=>s,Y$:()=>n,Yq:()=>o,ix:()=>a,mp:()=>i});var l=r(2099);let a=async()=>{console.log("hmsService: Fetching active checklist templates...");let{data:e,error:t}=await l.ND.from("checklist_templates").select("id, created_at, name, description").eq("is_active",!0).order("name");if(t)throw console.error("Error fetching checklist templates:",t),Error("Could not fetch checklist templates.");return e||[]},s=async e=>{console.log("hmsService: Fetching template with items for ID: ".concat(e));let{data:t,error:r}=await l.ND.from("checklist_templates").select("\n      id,\n      created_at, // Select created_at\n      name,\n      description,\n      checklist_template_items ( id, item_text, item_order )\n    ").eq("id",e).eq("is_active",!0).order("item_order",{referencedTable:"checklist_template_items",ascending:!0}).maybeSingle();if(r)throw console.error("Error fetching template with items:",r),Error("Could not fetch template details.");return t},i=async()=>{console.log("hmsService: Fetching checklists...");let{data:e,error:t}=await l.ND.from("checklists").select("\n      id,\n      created_at,\n      completed_at,\n      status,\n      template_id, // Include template_id\n      user_id, // Include user_id\n      template:checklist_templates ( name, description ),\n      user:profiles ( full_name ) -- Assuming a 'profiles' table linked to auth.users\n      -- department:departments ( name ) -- Optional join if department is linked to checklist or user\n    ").order("created_at",{ascending:!1});if(t)throw console.error("Error fetching checklists:",t),Error("Could not fetch checklists.");return(null==e?void 0:e.map(e=>{var t,r,l;return{id:e.id,template_id:e.template_id,user_id:e.user_id,template_name:(null==(t=e.template)?void 0:t.name)||"Ukjent Mal",template_description:(null==(r=e.template)?void 0:r.description)||null,created_by_name:(null==(l=e.user)?void 0:l.full_name)||"Ukjent Bruker",created_at:e.created_at,completed_at:e.completed_at,status:e.status}}))||[]},n=async(e,t,r)=>{console.log("hmsService: Creating checklist instance for template ".concat(e," by user ").concat(t));let a=Object.entries(r).map(e=>{let[t,r]=e;return{template_item_id:t,is_checked:r}}),{data:s,error:i}=await l.ND.rpc("create_new_checklist",{p_template_id:e,p_user_id:t,p_items:a});return i?(console.error("Error calling create_new_checklist RPC:",i),{success:!1,checklistId:null,error:"Database error during checklist creation."}):s&&"object"==typeof s&&"checklist_id"in s&&s.checklist_id?(console.log("Successfully created checklist with ID:",s.checklist_id),{success:!0,checklistId:s.checklist_id,error:null}):(console.error("RPC create_new_checklist did not return expected checklist_id",s),{success:!1,checklistId:null,error:"Failed to retrieve new checklist ID after creation."})},c=async e=>{var t,r,a;console.log("hmsService: Fetching checklist with items for ID: ".concat(e));let{data:s,error:i}=await l.ND.from("checklists").select("\n      id,\n      created_at,\n      completed_at,\n      status,\n      template_id,\n      user_id,\n      template:checklist_templates ( name, description ),\n      user:profiles ( full_name ),\n      checklist_items (\n        id,\n        template_item_id,\n        is_checked,\n        comment,\n        created_at,\n        template_item:checklist_template_items ( item_text )\n      )\n    ").eq("id",e).maybeSingle();if(i)throw console.error("Error fetching checklist with items:",i),Error("Could not fetch checklist details.");return s?{id:s.id,template_id:s.template_id,user_id:s.user_id,template_name:(null==(t=s.template)?void 0:t.name)||"Ukjent Mal",template_description:(null==(r=s.template)?void 0:r.description)||null,created_by_name:(null==(a=s.user)?void 0:a.full_name)||"Ukjent Bruker",created_at:s.created_at,completed_at:s.completed_at,status:s.status,checklist_items:(s.checklist_items||[]).map(e=>{var t;return{id:e.id,checklist_id:s.id,template_item_id:e.template_item_id,is_checked:e.is_checked,comment:e.comment,created_at:e.created_at,item_text:(null==(t=e.template_item)?void 0:t.item_text)||void 0}})}:null},o=async e=>{console.log("hmsService: Deleting checklist with ID: ".concat(e));let{error:t}=await l.ND.from("checklist_items").delete().eq("checklist_id",e);if(t)return console.error("Error deleting checklist items:",t),{success:!1,error:"Could not delete associated checklist items."};let{error:r}=await l.ND.from("checklists").delete().eq("id",e);return r?(console.error("Error deleting checklist:",r),{success:!1,error:"Could not delete the checklist."}):(console.log("Successfully deleted checklist with ID: ".concat(e)),{success:!0})}},7995:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>m});var l=r(5155),a=r(2115),s=r(5695),i=r(6874),n=r.n(i),c=r(6689),o=r(2099);function d(){let e=(0,s.useSearchParams)(),t=(0,s.useRouter)(),r=e.get("templateId"),[i,d]=(0,a.useState)(null),[m,u]=(0,a.useState)(!0),[h,p]=(0,a.useState)(null),[k,f]=(0,a.useState)({}),[_,g]=(0,a.useState)(!1),[v,x]=(0,a.useState)("idle"),[b,y]=(0,a.useState)(null),[j,w]=(0,a.useState)(null);(0,a.useEffect)(()=>{if((async()=>{let{data:{user:e}}=await o.ND.auth.getUser();e?w(e.id):(p("Bruker ikke logget inn."),u(!1))})(),!r){p("Ingen sjekkliste-mal ID funnet i URL."),u(!1);return}(async()=>{u(!0),p(null),x("idle");try{let e=await (0,c.Py)(r);if(e){d(e);let t={};e.checklist_template_items.forEach(e=>{t[e.id]=!1}),f(t)}else p("Kunne ikke finne sjekkliste-mal med ID: ".concat(r,"."))}catch(e){console.error("Error fetching template:",e),p("Feil ved lasting av sjekkliste-mal.")}finally{u(!1)}})()},[r,t]);let N=e=>{f(t=>({...t,[e]:!t[e]})),x("idle")},I=async()=>{if(!r||!i||!j){p("Kan ikke lagre sjekklisten: Mal, ID eller brukerinformasjon mangler."),x("error");return}g(!0),x("idle"),p(null);try{let e=await (0,c.Y$)(r,j,k);e.success&&e.checklistId?(x("success"),y(new Date().toLocaleTimeString("nb-NO",{hour:"2-digit",minute:"2-digit"})),setTimeout(()=>{t.push("/hms/sjekklister")},1500)):(x("error"),p(e.error||"Kunne ikke lagre sjekklisten. Pr\xf8v igjen."))}catch(e){console.error("Error submitting checklist:",e),x("error"),p("En uventet feil oppstod under lagring.")}finally{g(!1)}};return m||null===j?(0,l.jsx)("div",{className:"container mx-auto p-4",children:"Laster sjekkliste..."}):h&&(!i||void 0===j)?(0,l.jsx)("div",{className:"container mx-auto p-4 text-red-600",children:h}):i?(0,l.jsxs)("div",{className:"container mx-auto p-4",children:[(0,l.jsxs)("nav",{className:"text-sm text-gray-500 mb-4",children:[(0,l.jsx)(n(),{href:"/hms",className:"hover:underline",children:"Hjem"})," /",(0,l.jsx)(n(),{href:"/hms/sjekklister",className:"hover:underline",children:" Sjekklister"})," /",(0,l.jsx)("span",{className:"text-gray-700",children:" Ny"})]}),(0,l.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,l.jsx)("h1",{className:"text-2xl font-semibold",children:"Ny sjekkliste"}),"success"===v&&b&&(0,l.jsxs)("span",{className:"text-green-600 font-medium",children:["Lagret kl. ",b," ✓"]})]}),i.description&&(0,l.jsx)("p",{className:"text-gray-600 mb-6 bg-gray-50 p-3 rounded border border-gray-200",children:i.description}),(0,l.jsxs)("div",{className:"bg-white shadow-md rounded-lg overflow-hidden border border-gray-200",children:[(0,l.jsx)("div",{className:"bg-teal-600 text-white p-4",children:(0,l.jsx)("h2",{className:"text-xl font-semibold",children:i.name})}),(0,l.jsx)("ul",{className:"divide-y divide-gray-200",children:i.checklist_template_items.map((e,t)=>(0,l.jsxs)("li",{className:"p-4 flex items-center justify-between hover:bg-teal-50 transition-colors duration-150",children:[(0,l.jsxs)("div",{className:"flex items-center flex-grow mr-4",children:[(0,l.jsx)("span",{className:"text-gray-500 w-8 text-right mr-4 flex-shrink-0",children:t+1}),(0,l.jsx)("label",{htmlFor:"item-".concat(e.id),className:"flex-grow cursor-pointer text-gray-800",children:e.item_text})]}),(0,l.jsx)("input",{type:"checkbox",id:"item-".concat(e.id),checked:k[e.id]||!1,onChange:()=>N(e.id),className:"form-checkbox h-5 w-5 text-teal-600 rounded border-gray-300 focus:ring-teal-500 focus:ring-offset-0 focus:ring-2 cursor-pointer flex-shrink-0"})]},e.id))})]}),"error"===v&&h&&(0,l.jsx)("div",{className:"mt-4 text-red-600 bg-red-50 p-3 rounded border border-red-200",children:h}),(0,l.jsx)("div",{className:"mt-6 text-right",children:(0,l.jsx)("button",{onClick:I,disabled:_||"success"===v,className:"bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-opacity duration-150 ".concat(_||"success"===v?"opacity-50 cursor-not-allowed":""),children:_?"Lagrer...":"✅ FERDIGSTILL"})})]}):(0,l.jsx)("div",{className:"container mx-auto p-4",children:"Fant ikke sjekkliste-malen. Sjekk om IDen i URLen er korrekt."})}let m=()=>(0,l.jsx)(a.Suspense,{fallback:(0,l.jsx)("div",{className:"container mx-auto p-4",children:"Laster..."}),children:(0,l.jsx)(d,{})})}},e=>{var t=t=>e(e.s=t);e.O(0,[851,874,441,684,358],()=>t(5372)),_N_E=e.O()}]);